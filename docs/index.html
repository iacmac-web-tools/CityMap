<!DOCTYPE html>

<html lang="en" xmlns="https://www.w3.org/1999/xhtml">
<head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDsGLmipz7UZDNDp7PbU8JcOLhxir94H50" type="text/javascript"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
    <script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.7.3/bootstrap-slider.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.7.3/css/bootstrap-slider.css" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-dvf/0.3.1/leaflet-dvf.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-dvf/0.3.1/css/dvf.min.css" />

    <script type="text/javascript" src="RFregions.js"></script>

    <meta charset="utf-8" />

    <style>
        /*#region LEFALET FULLSCREEN ENABLING */

        .fullscreen-icon {
        }

        .leaflet-retina .fullscreen-icon {
        }
        /* one selector per rule as explained here : http://www.sitepoint.com/html5-full-screen-api/ */
        .leaflet-container:-webkit-full-screen {
            width: 100% !important;
            height: 100% !important;
            z-index: 99999;
        }

        .leaflet-container:-ms-fullscreen {
            width: 100% !important;
            height: 100% !important;
            z-index: 99999;
        }

        .leaflet-container:full-screen {
            width: 100% !important;
            height: 100% !important;
            z-index: 99999;
        }

        .leaflet-container:fullscreen {
            width: 100% !important;
            height: 100% !important;
            z-index: 99999;
        }

        .leaflet-pseudo-fullscreen {
            position: fixed !important;
            width: 100% !important;
            height: 100% !important;
            top: 0px !important;
            left: 0px !important;
            z-index: 99999;
        }

        /*#endregion */

        /*#region LEAFLET FILL PAGE AND SIDEBAR */

        html, body, #container {
            height: 100%;
            overflow: hidden;
            width: 100%;
            margin: 0px;
            padding: 0px;
        }

        #loadPin {
            width: 100%;
            height: 100%;
            position: fixed;
            z-index: 9999;
            background: url("https://centermed.pl/gif-load.gif") no-repeat;
            margin: 50px;
        }

        #loadPie {
            width: 100%;
            height: 100%;
            position: fixed;
            z-index: 9999;
            background: url("https://centermed.pl/gif-load.gif") no-repeat;
            margin: 50px;
        }

        #loadShape {
            width: 100%;
            height: 100%;
            position: fixed;
            z-index: 9999;
            background: url("https://centermed.pl/gif-load.gif") no-repeat;
            margin: 50px;
        }

        #sidebar {
            float: left;
            height: 100%;
            max-width: 100%;
            width: 255px;
        }

        #map {
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            height: 100%;
            width: auto;
        }

        .sidebar-wrapper {
            height: 100%;
            position: relative;
            width: 100%;
        }

        @media (max-width: 600px) {
            #sidebar {
                display: none;
            }
        }

        /*#endregion */

        /*#region LEGEND */
        ul {
            margin: 20px;
            list-style-type: none;
        }

        .input-color {
            position: relative;
        }

            .input-color input {
                padding-left: 20px;
            }

            .input-color .color-box {
                width: 10px;
                height: 10px;
                display: inline-block;
                background-color: #ccc;
                position: absolute;
                left: 5px;
                top: 9px;
            }
        /*#endregion */

        .table > tbody > tr > td {
            vertical-align: middle;
        }


        #features, .container, .panel {
            height: 100%;
            margin: 0px;
            padding: 0px;
            width: auto;
            position: static;
        }

        .panel-footer {
            position: absolute;
            width: 100%;
            bottom: 0;
        }

        .panel-body {
            height: 100%;
            position: absolute;
        }

        #txtCities {
            max-height: 85%;
            min-height: 20%;
            height: 60%;
            width: 220px;
     /*       max-width: 205px;
            min-width: 205px;*/
        }

        #txtPiechart {
            max-height: 85%;
            min-height: 20%;
            height: 60%;
            width: 220px;
        /*    max-width: 205px;
            min-width: 205px;*/
        }

       #txtShape {
            max-height: 85%;
            min-height: 20%;
            height: 60%;
            width: 220px;
  /*          max-width: 205px;
            min-width: 205px;*/
        }

        #ex1Slider .slider-selection {
            background: #BABABA;
        }

        #ex1Slider {
            width: 185px;
            margin-left: 8%;
        }

        .legend {
            line-height: 18px;
            color: #555;
        }

            .legend i {
                width: 16px;
                height: 16px;
                float: left;
                margin-right: 8px;
            }

        .legendShape {
            line-height: 18px;
            color: #555;
        }
        .legendShape i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }


        .info {
            padding: 6px 8px;
            font: 16px Helvetica;
            background: white;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
        }

            .info h4 {
                margin: 0 0 5px;
                color: #777;
            }

    </style>

    <title>CityMap ver.1.3.2</title>
</head>
<body>
    <div id="container">
        <div id="sidebar">
            <div class="sidebar-wrapper">
                <div class="container">
                    <ul class="nav nav-pills" style="margin: 0px;">
                        <li role="presentation" class="active"><a href="#Pin" data-toggle="tab" style="border-radius: 0;">Pin</a></li>
                        <li role="presentation"><a href="#Pie" data-toggle="tab" style="border-radius: 0;">Pie</a></li>
                        <li role="presentation"><a href="#Shape" data-toggle="tab" style="border-radius: 0;">Shape</a></li>
                        <li role="presentation"><a href="UserGuide.pdf" download="User guide" style="border-radius: 0; color: red">Help <i class="glyphicon glyphicon-question-sign"></i>
                        </a></li>
                    </ul>

                    <div class="tab-content clearfix">
                        <div class="tab-pane active" id="Pin">
                            <div id="features" class="panel panel-primary">
                                <div class="panel-body">
                                    <textarea id="txtCities" class="form-control" type="text" placeholder="Enter cities here line by line"></textarea>
                                    <div id="loadPin" style="visibility: hidden;"></div>
                                    <div id="messagesPin" style="color: red;"></div>
                                </div>

                                <div class="panel-footer">
                                    <button type="button" class="btn btn-primary" id="btnGetCoordinates" onclick="getCoordFromGoogle(document.getElementById('txtCities').value)">Pin Markers</button>
                                    <button type="button" class="btn btn-default" data-toggle="modal" data-target="#citiesCoordModal">Show Table</button>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane" id="Pie">
                            <div id="features" class="panel panel-primary">
                                <div class="panel-body">
                                    <div class="row">
                                        &emsp;&emsp;Radius norma:    <input id="radius_toggle" type="checkbox" disabled checked data-toggle="toggle">
                                    </div>
                                    <div class="row">
                                        <input id="radius_slider" data-slider-enabled="false" data-slider-id='ex1Slider' type="text" data-slider-min="9" data-slider-max="31" data-slider-step="1" data-slider-value="31" />
                                    </div>
                                    <p>&nbsp;</p>
                                    <textarea id="txtPiechart" class="form-control" type="text" placeholder="Enter your data here line by line"></textarea>
                                    <div id="loadPie" style="visibility: hidden;"></div>
                                    <div id="messagesPie" style="color: red;"></div>
                                </div>

                                <div class="panel-footer">
                                    <button type="button" class="btn btn-primary" id="btnGetCoordinates" onclick="getDatafromTxt(document.getElementById('txtPiechart').value)">PieChart</button>
                                    <button type="button" class="btn btn-default" data-toggle="modal" data-target="#legendModal">Legend</button>
                                    <button type="button" id="btnShowLegendOnMap" class="btn btn-default" disabled onclick="ShowLegendOnMap()">>></button>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane" id="Shape">
                            <div id="features" class="panel panel-primary">
                                <div class="panel-body">
                                    <textarea id="txtShape" class="form-control" type="text" placeholder="Enter regions value here line by line"></textarea>
                                    <div id="loadShape" style="visibility: hidden;"></div>
                                    <div id="messagesShape" style="color: red;"></div>
                                </div>

                                <div class="panel-footer">
                                    <button type="button" class="btn btn-primary" id="btnShowShape" onclick="getDatafromShapeTxt(document.getElementById('txtShape').value)">Show regions</button>
                                    <button type="button" class="btn btn-default" id="btnShowDensity" onclick="showDensity()">Density</button>
                                    <a href="RFregions.xlsx" download="Example"><img src="icon_xls.gif"></a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal -->
                    <div class="modal fade" id="citiesCoordModal" tabindex="-1" role="dialog" aria-labelledby="citiesCoordModalLabel" aria-hidden="true">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <table class="table table-striped" id="citiesTable"></table>
                                </div>

                            </div>
                        </div>
                    </div>

                    <!-- Modal -->
                </div>
                <div class="modal fade" id="legendModal" role="dialog" aria-labelledby="legendModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                    <div id="legend"></div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="map"></div>
    </div>



    <!-- #region ENABLING FULLSCREEN BUTTON FOR LEAFLET -->

    <script>
        (function () {

            L.Control.FullScreen = L.Control.extend({
                options: {
                    position: 'topleft',
                    title: 'Full Screen',
                    titleCancel: 'Exit Full Screen',
                    forceSeparateButton: false,
                    forcePseudoFullscreen: false,
                    fullscreenElement: false
                },

                onAdd: function (map) {
                    var className = 'leaflet-control-zoom-fullscreen', container, content = '';

                    if (map.zoomControl && !this.options.forceSeparateButton) {
                        container = map.zoomControl._container;
                    } else {
                        container = L.DomUtil.create('div', 'leaflet-bar');
                    }

                    if (this.options.content) {
                        content = this.options.content;
                    } else {
                        className += ' fullscreen-icon glyphicon glyphicon-fullscreen';
                    }

                    this._createButton(this.options.title, className, content, container, this.toggleFullScreen, this);

                    this._map.on('enterFullscreen exitFullscreen', this._toggleTitle, this);

                    return container;
                },

                _createButton: function (title, className, content, container, fn, context) {
                    this.link = L.DomUtil.create('a', className, container);
                    this.link.href = '#';
                    this.link.title = title;
                    this.link.innerHTML = content;

                    L.DomEvent
                        .addListener(this.link, 'click', L.DomEvent.stopPropagation)
                        .addListener(this.link, 'click', L.DomEvent.preventDefault)
                        .addListener(this.link, 'click', fn, context);

                    L.DomEvent
                        .addListener(container, fullScreenApi.fullScreenEventName, L.DomEvent.stopPropagation)
                        .addListener(container, fullScreenApi.fullScreenEventName, L.DomEvent.preventDefault)
                        .addListener(container, fullScreenApi.fullScreenEventName, this._handleEscKey, context);

                    L.DomEvent
                        .addListener(document, fullScreenApi.fullScreenEventName, L.DomEvent.stopPropagation)
                        .addListener(document, fullScreenApi.fullScreenEventName, L.DomEvent.preventDefault)
                        .addListener(document, fullScreenApi.fullScreenEventName, this._handleEscKey, context);

                    return this.link;
                },

                toggleFullScreen: function () {
                    var map = this._map;
                    map._exitFired = false;
                    if (map._isFullscreen) {
                        if (fullScreenApi.supportsFullScreen && !this.options.forcePseudoFullscreen) {
                            fullScreenApi.cancelFullScreen(this.options.fullscreenElement ? this.options.fullscreenElement : map._container);
                        } else {
                            L.DomUtil.removeClass(map._container, 'leaflet-pseudo-fullscreen');
                        }
                        map.invalidateSize();
                        map.fire('exitFullscreen');
                        map._exitFired = true;
                        map._isFullscreen = false;
                    }
                    else {
                        if (fullScreenApi.supportsFullScreen && !this.options.forcePseudoFullscreen) {
                            fullScreenApi.requestFullScreen(this.options.fullscreenElement ? this.options.fullscreenElement : map._container);
                        } else {
                            L.DomUtil.addClass(map._container, 'leaflet-pseudo-fullscreen');
                        }
                        map.invalidateSize();
                        map.fire('enterFullscreen');
                        map._isFullscreen = true;
                    }
                },

                _toggleTitle: function () {
                    this.link.title = this._map._isFullscreen ? this.options.title : this.options.titleCancel;
                },

                _handleEscKey: function () {
                    var map = this._map;
                    if (!fullScreenApi.isFullScreen(map) && !map._exitFired) {
                        map.fire('exitFullscreen');
                        map._exitFired = true;
                        map._isFullscreen = false;
                    }
                }
            });

            L.Map.addInitHook(function () {
                if (this.options.fullscreenControl) {
                    this.fullscreenControl = L.control.fullscreen(this.options.fullscreenControlOptions);
                    this.addControl(this.fullscreenControl);
                }
            });

            L.control.fullscreen = function (options) {
                return new L.Control.FullScreen(options);
            };

            /*
            Native FullScreen JavaScript API
            -------------
            Assumes Mozilla naming conventions instead of W3C for now
            source : http://johndyer.name/native-fullscreen-javascript-api-plus-jquery-plugin/
            */

            var
                fullScreenApi = {
                    supportsFullScreen: false,
                    isFullScreen: function () { return false; },
                    requestFullScreen: function () { },
                    cancelFullScreen: function () { },
                    fullScreenEventName: '',
                    prefix: ''
                },
                browserPrefixes = 'webkit moz o ms khtml'.split(' ');

            // check for native support
            if (typeof document.exitFullscreen !== 'undefined') {
                fullScreenApi.supportsFullScreen = true;
            } else {
                // check for fullscreen support by vendor prefix
                for (var i = 0, il = browserPrefixes.length; i < il; i++) {
                    fullScreenApi.prefix = browserPrefixes[i];
                    if (typeof document[fullScreenApi.prefix + 'CancelFullScreen'] !== 'undefined') {
                        fullScreenApi.supportsFullScreen = true;
                        break;
                    }
                }
                if (typeof document['msExitFullscreen'] !== 'undefined') {
                    fullScreenApi.prefix = 'ms';
                    fullScreenApi.supportsFullScreen = true;
                }
            }

            // update methods to do something useful
            if (fullScreenApi.supportsFullScreen) {
                if (fullScreenApi.prefix === 'ms') {
                    fullScreenApi.fullScreenEventName = 'MSFullscreenChange';
                } else {
                    fullScreenApi.fullScreenEventName = fullScreenApi.prefix + 'fullscreenchange';
                }
                fullScreenApi.isFullScreen = function () {
                    switch (this.prefix) {
                        case '':
                            return document.fullScreen;
                        case 'webkit':
                            return document.webkitIsFullScreen;
                        case 'ms':
                            return document.msFullscreenElement;
                        default:
                            return document[this.prefix + 'FullScreen'];
                    }
                };
                fullScreenApi.requestFullScreen = function (el) {
                    switch (this.prefix) {
                        case '':
                            return el.requestFullscreen();
                        case 'ms':
                            return el.msRequestFullscreen();
                        default:
                            return el[this.prefix + 'RequestFullScreen']();
                    }
                };
                fullScreenApi.cancelFullScreen = function () {
                    switch (this.prefix) {
                        case '':
                            return document.exitFullscreen();
                        case 'ms':
                            return document.msExitFullscreen();
                        default:
                            return document[this.prefix + 'CancelFullScreen']();
                    }
                };
            }

            // jQuery plugin
            if (typeof jQuery !== 'undefined') {
                jQuery.fn.requestFullScreen = function () {
                    return this.each(function () {
                        var el = jQuery(this);
                        if (fullScreenApi.supportsFullScreen) {
                            fullScreenApi.requestFullScreen(el);
                        }
                    });
                };
            }

            // export api
            window.fullScreenApi = fullScreenApi;
        })();
    </script>

    <!-- #endregion -->


    <script>
        // Initialise elements on page

        // Enabling button Show table
        $('#citiesCoordModal').on('shown.bs.modal', function () {
            $('#myInput').focus()
        })
        // Enabling button Show legend
        $('#legendModal').on('shown.bs.modal', function () {
            $('#myInput').focus()
        })

        $("#radius_slider").slider({
            tooltip_position: 'bottom'
        });
        $("#radius_slider").on("slide", function (slideEvt) {
            $("#radius_sliderSliderVal").text(slideEvt.value);
        });


        function getRandomColor() {
            var letters = '0123456789ABCDEF';
            var color = '#';
            for (var i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

		var colorWell = [];
        var colors = ['#FF0000', '#00CC33', '#0099FF', '#FFFF33', '#FFCC00', '#FF9933', '#990033', '#CC9999', '#993399', '#FF99FF', '#9900FF', '#9999FF', '#000099', '#006666', '#00FFFF', '#006600', '#996600', '#66FF00', '#99CC33', '#CCCC33', '#666600', '#CCCCCC'];
        var geo = new google.maps.Geocoder();
        var cities = [];
        var markersLayer = new L.LayerGroup();
        var nextAddress = 0;
        var delay = 100;
        var cities_list = [];
        var piechartLayer = new L.PieChartDataLayer();
        var piechartarray = [];
        var alltxt = [];
        var PieChart = false;
        var geojson = new L.geoJson();
        var Legend = L.control({ position: 'bottomright' });
        var legendShape = L.control({ position: 'bottomright' });
        var nodataflag = false;
        var grades = [0, 10, 20, 50, 100, 200, 500, 1000];

        // Links to map sources
        var yandexMap = L.tileLayer('https://vec{s}.maps.yandex.net/tiles?l=map&v=4.55.2&z={z}&x={x}&y={y}&scale=2&lang=ru_RU', {
            subdomains: ['01', '02', '03', '04'], reuseTiles: true, updateWhenIdle: false
        });
        var yandexMapEng = L.tileLayer('https://vec{s}.maps.yandex.net/tiles?l=map&v=4.55.2&z={z}&x={x}&y={y}&scale=2&lang=en_US', {
            subdomains: ['01', '02', '03', '04'], reuseTiles: true, updateWhenIdle: false
        });
        var osmMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
        var roadsMap = L.tileLayer('https://korona.geog.uni-heidelberg.de/tiles/roads/x={x}&y={y}&z={z}');
        var stamMap = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}.{ext}', { subdomains: 'abcd', minZoom: 0, maxZoom: 20, ext: 'png' });
        var esriMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}');
        var googleStreets = L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { maxZoom: 20, subdomains: ['mt0', 'mt1', 'mt2', 'mt3'] });


        // Initialize map
        var map = L.map('map', {
            center: [56.73, 36.99],
            zoom: 6,
            layers: [yandexMap],
            fullscreenControl: true,
            fullscreenControlOptions: {
                position: 'topleft'
            }
        });
        var baseMaps = {
            "Yandex Map": yandexMap,
            "Yandex Map ENG": yandexMapEng,
            "Google Map": googleStreets,
            "Open Street Map": osmMap,
            "Toner Map": stamMap,
            "RoadsMap": roadsMap,
            "Esri Map": esriMap
        };


        // Attach layers to map
        map.options.crs = L.CRS.EPSG3395;
        L.control.layers(baseMaps).addTo(map);
        markersLayer.addTo(map);

        // Смена типа карты в правом верхнем углу
        map.on('baselayerchange', function (event) {
            if (event.name == "Yandex Map" || event.name == "Yandex Map ENG") {
                map.options.crs = L.CRS.EPSG3395;
            }
            else {
                map.options.crs = L.CRS.EPSG3857;
            }
            clearMap();
            if (PieChart == false) {
                cities.forEach(function (city) {
                    markersLayer.addLayer(L.marker([city.lat, city.lon]).bindPopup(city.fullname));
                });
            }
            else {
                redrawPieChart();
            }
        });

        // Pin markers on map based on cities
        var updateMap = function () {
            var bounds = [];
            clearMap();

            cities.forEach(function (city) {
                markersLayer.addLayer(L.marker([city.lat, city.lon]).bindPopup(city.fullname));
                bounds.push([city.lat, city.lon]);
            });

            var group = new L.LatLngBounds(bounds);
            map.fitBounds(group);

        };

        // Show cities coordinates on modal table
        var fillTable = function () {
            document.getElementById("citiesTable").innerHTML = "";
            var tbody = $('#citiesTable');
            var props = ["txtName","fullname", "lat", "lon"];
            // Write table head
            var th = $('<thead>');
            var tr = $('<tr>');
            $('<th>').html('Object').appendTo(tr);
            $('<th>').html('Address').appendTo(tr);
            $('<th>').html('Latitude').appendTo(tr);
            $('<th>').html('Longitude').appendTo(tr);
            th.append(tr);
            tbody.append(th);
            //Write table data
            var tb = $('<tbody>');
            $.each(cities, function (i, city) {
                var tr = $('<tr>');
                $.each(props, function (i, prop) {
                    $('<td>').html(city[prop]).appendTo(tr);
                });
                tb.append(tr);
            });
            tbody.append(tb);
        }

        //Change radius-toggle
        $(function () {
            $('#radius_toggle').change(function () {
                if (radius_toggle.checked) {
                    $('#radius_slider').slider('setValue', 31);
                }
                else {
                    $('#radius_slider').slider('setValue', 17);
                }
                redrawPieChart();
            })
        })

        //Change radius-slider
        $("#radius_slider").on("slide", function (slideEvt) {
            redrawPieChart();
        });

        function clearMap() {
            markersLayer.clearLayers();
            piechartLayer.clearLayers();
        }

        function ShowLegendOnMap() {
            if (Legend.getPosition() == 'bottomright') { Legend.setPosition('none') }
            else { Legend.setPosition('bottomright') }
        }

        function getDatafromTxt(val) {
            if (val != '') {
                PieChart = true;
                document.getElementById('loadPie').style.visibility = "visible";
                nextAddress = 0;
                delay = 100;
                cities = [];
                alltxt = [];
                piechartarray = [];
                var records_list = val.trim().split(/\r?\n/);
                var current_data = [];
                for (var i = 0; i < records_list.length; i++) {
                    current_data[i] = {
                        city: records_list[i].trim().split(/\t/)[0],
                        txt: records_list[i].trim().split(/\t/)[1],
                        val: records_list[i].trim().split(/\t/)[2]
                    }
                }
                var countarray = [];
                for (var i = 0; i < records_list.length; i++) {
                    if (alltxt.indexOf(current_data[i].txt) == -1) {
                        alltxt.push(current_data[i].txt);
                        countarray.push(0);
                    }
                }
                while (alltxt.length > colors.length) {
                    colors.push(getRandomColor());
                }

                for (var i = 0; i < records_list.length; i++) {
                    if (piechartarray.map(x => x.City).indexOf(current_data[i].city) == -1) {
                        piechartarray.push({
                            City: current_data[i].city,
                            fullname: '',
                            Latitude: 0,
                            Longitude: 0,
                            Count: countarray.slice(),
                            Total: parseFloat(current_data[i].val),
                        });
                    }
                    else {
                        piechartarray[piechartarray.map(x => x.City).indexOf(current_data[i].city)].Total += parseFloat(current_data[i].val);
                    }
                }
                for (var i = 0; i < current_data.length; i++) {
                    piechartarray[piechartarray.map(x => x.City).indexOf(current_data[i].city)].Count[alltxt.indexOf(current_data[i].txt)] = current_data[i].val;
                }
                document.getElementById("messagesPie").innerHTML = '';
                theNext();
            }
            else { document.getElementById("messagesPie").innerHTML = 'Empty string!'; }
        }

        function makePiechart() {
            var bounds = [];
            clearMap();
            $('#radius_toggle').bootstrapToggle('enable');
            $("#radius_slider").slider("enable");
            document.getElementById("btnShowLegendOnMap").disabled = false;

            //Удаляем нераспознанные города из массива маркеров
            while (piechartarray.length != cities.length) {
                for (var i = 0; i < piechartarray.length; i++) {
                    if (cities.map(x => x.txtName).indexOf(piechartarray[i].City) == -1) {
                        piechartarray.splice(i, 1);
                    }
                }
            }

            //Заносим в массив маркеров значения широты и долготы
            for (var i = 0; i < cities.length; i++) {
                var x = piechartarray.map(x => x.City).indexOf(cities[i].txtName);
                piechartarray[x].Latitude = cities[i].lat;
                piechartarray[x].Longitude = cities[i].lon;
                piechartarray[x].fullname = cities[i].fullname;
                bounds.push([cities[i].lat, cities[i].lon]);
            }

            var max = Math.max.apply(Math, piechartarray.map(function (o) { return o.Total; }));
            var min = Math.min.apply(Math, piechartarray.map(function (o) { return o.Total; }));

            for (var i = piechartarray.length - 1; i >= 0; i--) {
                var data = {};
                var chartOptions = {};
                if (radius_toggle.checked) {
                    var radius = 9 + (parseInt(radius_slider.value) - 8) * (piechartarray[i].Total - min) / (max - min);
                    if (!radius) { radius = 15 }
                }
                else { radius = parseInt(radius_slider.value) }


                for (var j = 0; j < alltxt.length; j++) {
                    if (piechartarray[i].Count[j] != 0) {
                        data[alltxt[j].trim()] = piechartarray[i].Count[j] / piechartarray[i].Total,
                        chartOptions[alltxt[j].trim()] = {
                            fillColor: colors[j],
                            color: '#000000',
                            displayText: function (value) {
                                return (value * 100).toFixed(1).toString() + '%';
                            }
                        }
                    }
                }
                var options = {
                    radius: radius,
                    fillOpacity: 1,
                    data: data,
                    chartOptions: chartOptions,
                }

                var bchMarker = new L.PieChartMarker(new L.LatLng(piechartarray[i].Latitude, piechartarray[i].Longitude), options);
                var str = "<h3>" + piechartarray[i].fullname + "</h3><table class=\"table table-bordered\"><tr style=\"font-weight:bold; color:white;\"><th style=\"background-color: #337ab7\">Item</th><th style=\"background-color: #337ab7\">Count</th></tr>";
                for (var j = 0; j < alltxt.length; j++) {
                    if (piechartarray[i].Count[j] != 0) {
                        str += "<tr>";
                        str += "<td style=\"font-weight: bold; padding-top:2px;\"><div class=\"data-layer-legend\"><div class=\"legend-box\" style=\"background-color:" + colors[j] + ";border-color:#000000;\"></div><div class=\"key\" style=\"font-size: 12pt; font-family: Helvetica ; \">" + alltxt[j] + "</div></div></td>";
                        str += "<td>" + piechartarray[i].Count[j] + "</td>";
                        str += "</tr>";
                    }
                }
                str += "</table>";
                bchMarker.bindPopup(str, {
                    minWidth: 400
                });
                bchMarker.addTo(piechartLayer);
            }

            //Добавляем итоговый слой PieChart маркеров на карту
            map.addLayer(piechartLayer);

            //Добавляем легенду на ShowModal
            $('#legend').html('');
            //var str = "<ul>";
            //for (var j = 0; j < alltxt.length; j++) {
            //    var sum = 0;
            //    for (var i = 0; i < piechartarray.length; i++) { sum += parseInt(piechartarray[i].Count[j]); }
            //    str += "<li><div class=\"input-color\"><input type=\"text\" style = \"width: 70%;\" value=\"" + alltxt[j] + "\t(N = " + sum + ")\" /><div class=\"color-box\" style=\"background-color:" + colors[j] + ";\"></div></div></li>";
            //}
            //str += "</ul>";
            var str = "<div style=\"box-shadow:none;\" class=\"info legend leaflet-control\">";
            for (var j = 0; j < alltxt.length; j++) {
                var sum = 0;
                for (var i = 0; i < piechartarray.length; i++) { sum += parseInt(piechartarray[i].Count[j]); }
                //str += "<i style=\"background:" + colors[j] + "\"></i>" + alltxt[j] + "\t(N = " + sum +  ")<br>";
            	str += "<input type=\"color\" value=\""+colors[j]+"\" id=\"colorWell"+j+"\">\t" + alltxt[j] + "\t(N = " + sum +  ")<br>";
            }
            str += "</div>";
            $('#legend').html(str);


for (var j = 0; j < alltxt.length; j++) { colorWell[j] = document.querySelector("#colorWell"+j); 
colorWell[j].addEventListener("change", updateAll, false);}


            //Добавляем легенду на карту
            map.removeControl(Legend);
            Legend.onAdd = function (map) {
                var div = L.DomUtil.create('div', 'info legend');

                for (var i = 0; i < alltxt.length; i++) {
                    var sum = 0;
                    for (var j = 0; j < piechartarray.length; j++) { sum += parseInt(piechartarray[j].Count[i]); }
                    div.innerHTML += '<i style="background:' + colors[i] + '"></i> ' + alltxt[i] + "\t(N = " + sum + ")<br>";
                }
                return div;
            };
            Legend.addTo(map);


            //Фокусируемся на входящих маркерах
            if (piechartarray.length != 0) {
                var group = new L.LatLngBounds(bounds);
                map.fitBounds(group);
            }

        }

        function updateAll(event) {
  var str= event.target.id;
  colors[str.substring(9)] = event.target.value;
  redrawPieChart();
Legend.setPosition('bottomright') ;
}

        function redrawPieChart() {
            clearMap();

            var max = Math.max.apply(Math, piechartarray.map(function (o) { return o.Total; }));
            var min = Math.min.apply(Math, piechartarray.map(function (o) { return o.Total; }));

            for (var i = piechartarray.length - 1; i >= 0; i--) {
                var data = {};
                var chartOptions = {};
                if (radius_toggle.checked) {
                    var radius = 9 + (parseInt(radius_slider.value) - 8) * (piechartarray[i].Total - min) / (max - min);
                    if (!radius) { radius = 15 }
                }
                else { radius = parseInt(radius_slider.value) }

                for (var j = 0; j < alltxt.length; j++) {
                    if (piechartarray[i].Count[j] != 0) {
                        data[alltxt[j].trim()] = piechartarray[i].Count[j] / piechartarray[i].Total,
                        chartOptions[alltxt[j].trim()] = {
                            fillColor: colors[j],
                            color: '#000000',
                            displayText: function (value) {
                                return (value * 100).toFixed(1).toString() + '%';
                            }
                        }
                    }
                }
                var options = {
                    radius: radius,
                    fillOpacity: 1,
                    data: data,
                    chartOptions: chartOptions,
                }

                var bchMarker = new L.PieChartMarker(new L.LatLng(piechartarray[i].Latitude, piechartarray[i].Longitude), options);
                var str = "<h3>" + piechartarray[i].fullname + "</h3><table class=\"table table-bordered\"><tr style=\"font-weight:bold; color:white;\"><th style=\"background-color: #337ab7\">Item</th><th style=\"background-color: #337ab7\">Count</th></tr>";
                for (var j = 0; j < alltxt.length; j++) {
                    if (piechartarray[i].Count[j] != 0) {
                        str += "<tr>";
                        str += "<td style=\"font-weight: bold; padding-top:2px;\"><div class=\"data-layer-legend\"><div class=\"legend-box\" style=\"background-color:" + colors[j] + ";border-color:#000000;\"></div><div class=\"key\" style=\"font-size: 12pt; font-family: Helvetica ; \">" + alltxt[j] + "</div></div></td>";
                        str += "<td>" + piechartarray[i].Count[j] + "</td>";
                        str += "</tr>";
                    }
                }
                str += "</table>";
                bchMarker.bindPopup(str, {
                    minWidth: 400
                });
                bchMarker.addTo(piechartLayer);
            }

            //Добавляем итоговый слой PieChart маркеров на карту
            map.addLayer(piechartLayer);
        }

        function getDatafromShapeTxt(val) {
            geojson.clearLayers();
            nodataflag = false;
            document.getElementById("messagesShape").innerHTML = '';
            if (val != '') {
                document.getElementById('loadShape').style.visibility = "visible";
                val = val.replace(/,/g,".");
                var records_list = val.trim().split(/\r?\n/);
                var parametr = records_list[0].split("*");
                if (!parametr[1]) { parametr[1] = ''; }
                records_list.shift();
                var i = 0;
                RFregionsData.features.forEach(function (features) {
                    features.properties.custom = records_list[i];
                    if (!records_list[i]) { nodataflag = true;}
                    i++;
                });
                var i = 0, q = records_list.length;
                while (i<q) {
                    if (!records_list[i]) { records_list.splice(i, 1); q--; }
                    else { i++;}
                }

                var max = Math.max.apply(Math,records_list);
                var min = Math.min.apply(Math, records_list);
                max = Math.log(max);
                min = Math.log(min);
                grades[0] = min;
                var z = (max - min) / 8;
                for (i = 1; i<8; i++)
                    {
                    grades[i] = grades[i-1]+z;
                }
                for (i = 0; i < 8; i++) {
                    grades[i] = Math.pow(2.71828, grades[i]);
                    (grades[i] > 1 ? grades[i] = Math.floor(grades[i]) : grades[i] = grades[i].toFixed(3));
                }

                geojson = L.geoJson(RFregionsData, { style: customstyle, onEachFeature: onEachFeature }).bindPopup(function (layer) {
                    var str = layer.feature.properties.name + "<br>" + parametr[0] + ": " + layer.feature.properties.custom + " " + parametr[1];
                    return str;
                }).addTo(map);

                function onEachFeature(feature, layer) {
                    layer.on({
                        mouseover: highlightFeature,
                        mouseout: resetHighlight
                    });
                }

                function resetHighlight(e) {
                    geojson.resetStyle(e.target);
                }

                function highlightFeature(e) {
                    var layer = e.target;

                    layer.setStyle({
                        weight: 3,
                        color: '#666',
                        dashArray: '',
                        fillOpacity: 0.7
                    });

                    if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                        layer.bringToFront();
                    }
                }

                legendShape.addTo(map);
                map.setView([66.73, 100.99], 3);
                document.getElementById('loadShape').style.visibility = "hidden";
            }
            else { document.getElementById("messagesShape").innerHTML = 'Empty string!'; }
        }

        function showDensity() {
            geojson.clearLayers();
            document.getElementById('loadShape').style.visibility = "visible";
            grades = [0, 10, 20, 50, 100, 200, 500, 1000];
            nodataflag = false;

            //var myStyle = {
            //    "color": "#ff7800",
            //    "weight": 1,
            //    "opacity": 0.65
            //};
            //var shpfile = new L.Shapefile('https://raw.githubusercontent.com/iacmac-web-tools/CityMap/master/docs/shape.zip', {
            //    onEachFeature: function (feature, layer) {
            //        /* Add some colors based on shapefile features */
            //    }
            //});
            //shpfile.addTo(map);

            geojson = L.geoJson(RFregionsData, { style: style, onEachFeature: onEachFeature }).bindPopup(function (layer) {
                var str = layer.feature.properties.name + "<br> Плотность населения: " + layer.feature.properties.density + " чел/км²";
                return str;
            }).addTo(map);

            function onEachFeature(feature, layer) {
                layer.on({
                    mouseover: highlightFeature,
                    mouseout: resetHighlight
                });
            }

            function resetHighlight(e) {
                geojson.resetStyle(e.target);
            }

            function highlightFeature(e) {
                var layer = e.target;

                layer.setStyle({
                    weight: 3,
                    color: '#666',
                    dashArray: '',
                    fillOpacity: 0.7
                });

                if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                    layer.bringToFront();
                }
            }

            legendShape.addTo(map);
            map.setView([66.73, 100.99], 3);
            document.getElementById('loadShape').style.visibility = "hidden";
        }


        legendShape.onAdd = function (map) {

            var div = L.DomUtil.create('div', 'info legendShape');

            // loop through our density intervals and generate a label with a colored square for each interval
            if (nodataflag) { div.innerHTML = '<i style="background:#8ed2a3"></i>Нет данных<br>'; }
            for (var i = 0; i < grades.length; i++) {
                div.innerHTML +=
                    '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
                    grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
            }

            return div;
        };

        function getColor(d) {
            return !d ? '#8ed2a3' :
                   d > grades[7] ? '#800026' :
                   d > grades[6] ? '#BD0026' :
                   d > grades[5] ? '#E31A1C' :
                   d > grades[4] ? '#FC4E2A' :
                   d > grades[3] ? '#FD8D3C' :
                   d > grades[2] ? '#FEB24C' :
                   d > grades[1] ? '#FED976' :
                            '#FFEDA0';
        }

        function customstyle(feature) {
            return {
                fillColor: getColor(feature.properties.custom),
                weight: 1,
                opacity: 1,
                color: 'white',
                dashArray: '',
                fillOpacity: 0.7
            };
        }

        function style(feature) {
            return {
                fillColor: getColor(feature.properties.density),
                weight: 1,
                opacity: 1,
                color: 'white',
                dashArray: '',
                fillOpacity: 0.7
            };
        }

        // ====== Geocoding ======
        function getCoordFromGoogle(val) {
            if (val != '') {
                PieChart = false;
                nextAddress = 0;
                delay = 100;
                cities = [];
                cities_list = val.trim().split(/\r?\n/);
                document.getElementById('loadPin').style.visibility = "visible";
                document.getElementById("messagesPin").innerHTML = '';
                theNext();
            }
            else { document.getElementById("messagesPin").innerHTML = 'Empty string!'; }
        }

        function theNext() {
            if (PieChart == false) {
                if (nextAddress < cities_list.length) {
                    setTimeout('getAddress("' + cities_list[nextAddress] + '",theNext)', delay);
                    nextAddress++;
                } else {
                    // We're done. Show map bounds
                    if (cities.length != 0) {
                        updateMap();
                        fillTable();
                    }
                    document.getElementById('loadPin').style.visibility = "hidden";
                }
            }
            else {
                if (nextAddress < piechartarray.length) {
                    setTimeout('getAddress("' + piechartarray[nextAddress].City + '",theNext)', delay);
                    nextAddress++;
                } else {
                    // We're done. Show map bounds
                    if (cities.length != 0) {
                        makePiechart();
                    }
                    document.getElementById('loadPie').style.visibility = "hidden";
                }
            }

        }

        function getAddress(search, next) {
            geo.geocode({ address: search }, function (results, status) {
                // If that was successful
                if (status == google.maps.GeocoderStatus.OK) {
                    var obj = {
                        txtName: search,
                        fullname: results[0].formatted_address,
                        lat: Math.round(results[0].geometry.location.lat() * 10000000) / 10000000,
                        lon: Math.round(results[0].geometry.location.lng() * 10000000) / 10000000
                    };
                    cities.push(obj);
                }
                    // ====== Decode the error status ======
                else {
                    // === if we were sending the requests to fast, try this one again and increase the delay
                    if (status == google.maps.GeocoderStatus.OVER_QUERY_LIMIT) {
                        nextAddress--;
                        delay++;
                    } else {
                        var reason = "Code " + status;
                        var msg = 'error = "' + search + '"<br>';
                        if (PieChart == false) { document.getElementById("messagesPin").innerHTML += msg; }
                        else { document.getElementById("messagesPie").innerHTML += msg; }
                    }
                }
                next();
            }
            );
        }
    </script>

</body>
</html>
